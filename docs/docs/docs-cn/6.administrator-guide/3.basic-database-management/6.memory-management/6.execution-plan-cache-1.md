执行计划缓存 
===========================



执行 `EXPLAIN` 语句看到的执行计划是预估的，在 Plan Cache 中缓存的执行计划才是真实的。Plan Cache 可以避免硬解析 SQL 语句，当同样的 SQL 请求到 OceanBase 数据库时，会从 Cache 中获得语句的已分析版本以加速语句执行。

与 Plan Cache 相关的配置项 
----------------------------



|            配置项            |                 说明                  |
|---------------------------|-------------------------------------|
| plan_cache_evict_interval | 该配置项用于设置检查执行计划是否需要淘汰的间隔时间，默认值为 30s。 |



与 Plan Cache 相关的系统变量 
-----------------------------



|                系统变量                 |                                                             说明                                                             |
|-------------------------------------|----------------------------------------------------------------------------------------------------------------------------|
| ob_plan_cache_percentage            | 该系统变量用于设置计划缓存可使用内存占租户内存的百分比。计划缓存最多可使用内存（内存上限绝对值）= 租户内存上限 \* ob_plan_cache_percentage/100，默认值为 5。                           |
| ob_plan_cache_evict_high_percentage | 该系统变量用于设置触发计划缓存淘汰的内存大小在内存上限绝对值的百分比。触发计划缓存淘汰的内存大小(淘汰计划的高水位线) = 内存上限绝对值 \* ob_plan_cache_evict_high_percentage/100，默认值为  90。 |
| ob_plan_cache_evict_low_percentage  | 该系统变量设置停止淘汰计划的内存。停止淘汰计划的内存（淘汰计划的低水位线) =内存上限绝对值 \* ob_plan_cache_evict_low_percentage/100，默认值为 50。                          |



举例来讲，假如一个租户内存大小为 10 G， `ob_plan_cache_percentage` 的值为 10， `ob_plan_cache_evict_high_percentage` 的值为 90， `ob_plan_cache_evict_low_percentage` 的值为 50。则：

* 计划缓存内存上限绝对值 ＝ 10 G \* 10 / 100 = 1 G

  

* 淘汰计划的高水位线 = 1 G \* 90 / 100 = 0.9 G

  

* 淘汰计划的低水位线 ＝ 1 G \* 50 / 100 = 0.5 G

  




当该租户在某个 OBServer 上的计划缓存使用超过 0.9 G 时，会触发淘汰，且优先淘汰最久未执行的计划。当淘汰到使用内存只有 0.5 G 时，则停止淘汰。如果淘汰速度没有新计划生成的速度快，则当计划缓存使用内存达到内存上限绝对值 1 G 时，将不再往计划缓存中添加新计划，直到淘汰后使用的内存小于 1 G 时才会再次添加新计划到计划缓存中。
