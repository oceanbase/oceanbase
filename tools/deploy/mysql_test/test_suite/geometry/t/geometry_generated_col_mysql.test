#owner: ht353245
#owner group: shenzhen
--echo # ----------------------------------------------------------------------
--echo # Base test of GEOMETRY spatial index.
--echo # ----------------------------------------------------------------------
--source mysql_test/test_suite/geometry/t/import_default_srs_data_mysql.inc

--disable_warnings
drop table if exists t1;
--enable_warnings

CREATE TABLE t1 (x INTEGER,
                 y INTEGER,
                 g POINT GENERATED ALWAYS AS (POINT(x, y)) NOT NULL SRID 0);
SHOW COLUMNS FROM t1;
INSERT INTO t1(x,y) VALUES (0, 0);
INSERT INTO t1(x,y) VALUES (0.1, 0.1);
SELECT x,y,st_astext(g) FROM t1 ORDER BY x;
DROP TABLE t1;

CREATE TABLE t1 (x INTEGER,
                 y INTEGER,
                 g POINT GENERATED ALWAYS AS (POINT(x, y)) NOT NULL SRID 4326);
SHOW COLUMNS FROM t1;
--error 3643
INSERT INTO t1(x,y) VALUES (0, 0);
--error 3643
INSERT INTO t1(x,y) VALUES (0.1, 0.1);
SELECT x,y,st_astext(g) FROM t1 ORDER BY x;
DROP TABLE t1;

CREATE TABLE t1 (x INTEGER,
                 y INTEGER,
                 g POINT GENERATED ALWAYS AS (ST_GEOMFROMTEXT('POINT(1 1)', 4326)) STORED NOT NULL SRID 4326);
SHOW COLUMNS FROM t1;
INSERT INTO t1(x,y) VALUES (0, 0);
INSERT INTO t1(x,y) VALUES (0.1, 0.1);
DROP TABLE t1;

CREATE TABLE t1 (x INTEGER,
                 y INTEGER,
                 g POINT GENERATED ALWAYS AS (ST_GEOMFROMTEXT('POINT(1 1)', 0)) STORED NOT NULL SRID 4326);
SHOW COLUMNS FROM t1;
--error 3643
INSERT INTO t1(x,y) VALUES (0, 0);
--error 3643
INSERT INTO t1(x,y) VALUES (0.1, 0.1);
DROP TABLE t1;

CREATE TABLE t1 (g GEOMETRY NOT NULL SRID 4326,
                 i INT GENERATED ALWAYS AS (ST_INTERSECTS(ST_GEOMFROMTEXT('POINT(0 0)', 4326), g)));
SHOW COLUMNS FROM t1;
INSERT INTO t1(g) VALUES (ST_GEOMFROMTEXT('MULTIPOLYGON(((0 0,10 0,10 10,0 10,0 0)))', 4326));
SELECT i,st_astext(g) FROM t1 ORDER BY i;
DROP TABLE t1;

CREATE TABLE t1 (g GEOMETRY NOT NULL SRID 4326,
                 i INT GENERATED ALWAYS AS (ST_INTERSECTS(ST_GEOMFROMTEXT('POINT(0 0)', 4326), g)));
SHOW COLUMNS FROM t1;
INSERT INTO t1(g) VALUES (ST_GEOMFROMTEXT('MULTIPOLYGON(((1 1,10 0,10 10,0 10,1 1)))', 4326));
SELECT i,st_astext(g) FROM t1 ORDER BY i;
DROP TABLE t1;

CREATE TABLE t1 (g GEOMETRY NOT NULL SRID 4326,
                 i INT GENERATED ALWAYS AS (ST_INTERSECTS(g, ST_GEOMFROMTEXT('POINT(0 0)', 4326))));
SHOW COLUMNS FROM t1;
INSERT INTO t1(g) VALUES (ST_GEOMFROMTEXT('MULTIPOLYGON(((0 0,10 0,10 10,0 10,0 0)))', 4326));
SELECT i,st_astext(g) FROM t1 ORDER BY i;
DROP TABLE t1;

CREATE TABLE t1 (g GEOMETRY NOT NULL SRID 4326,
                 i INT GENERATED ALWAYS AS (ST_INTERSECTS(g, ST_GEOMFROMTEXT('POINT(0 0)', 4326))));
SHOW COLUMNS FROM t1;
INSERT INTO t1(g) VALUES (ST_GEOMFROMTEXT('MULTIPOLYGON(((1 1,10 0,10 10,0 10,1 1)))', 4326));
SELECT i,st_astext(g) FROM t1 ORDER BY i;
DROP TABLE t1;

CREATE TABLE t1 (g GEOMETRY NOT NULL SRID 4326,
                 i INT GENERATED ALWAYS AS (ST_INTERSECTS(ST_GEOMFROMTEXT('POINT(0 0)', 4326), g)) STORED);
SHOW COLUMNS FROM t1;
INSERT INTO t1(g) VALUES (ST_GEOMFROMTEXT('MULTIPOLYGON(((0 0,10 0,10 10,0 10,0 0)))', 4326));
SELECT i,st_astext(g) FROM t1 ORDER BY i;
DROP TABLE t1;

CREATE TABLE t1 (g GEOMETRY NOT NULL SRID 4326,
                 i INT GENERATED ALWAYS AS (ST_INTERSECTS(ST_GEOMFROMTEXT('POINT(0 0)', 4326), g)) STORED);
SHOW COLUMNS FROM t1;
INSERT INTO t1(g) VALUES (ST_GEOMFROMTEXT('MULTIPOLYGON(((1 1,10 0,10 10,0 10,1 1)))', 4326));
SELECT i,st_astext(g) FROM t1 ORDER BY i;
DROP TABLE t1;

CREATE TABLE t1 (g GEOMETRY NOT NULL SRID 4326,
                 i INT GENERATED ALWAYS AS (ST_INTERSECTS(g, ST_GEOMFROMTEXT('POINT(0 0)', 4326))) STORED);
SHOW COLUMNS FROM t1;
INSERT INTO t1(g) VALUES (ST_GEOMFROMTEXT('MULTIPOLYGON(((0 0,10 0,10 10,0 10,0 0)))', 4326));
SELECT i,st_astext(g) FROM t1 ORDER BY i;
DROP TABLE t1;

CREATE TABLE t1 (g GEOMETRY NOT NULL SRID 4326,
                 i INT GENERATED ALWAYS AS (ST_INTERSECTS(g, ST_GEOMFROMTEXT('POINT(0 0)', 4326))) STORED);
SHOW COLUMNS FROM t1;
INSERT INTO t1(g) VALUES (ST_GEOMFROMTEXT('MULTIPOLYGON(((1 1,10 0,10 10,0 10,1 1)))', 4326));
SELECT i,st_astext(g) FROM t1 ORDER BY i;
DROP TABLE t1;

# bugfix: 
CREATE TABLE t1(id INT, p POLYGON GENERATED ALWAYS AS (ST_GeomFromText('POINT(15 20)',0)) STORED);
--error 1416
INSERT INTO t1(id) VALUES (1);
DROP TABLE t1;

--disable_warnings
drop table if exists t2;
--enable_warnings
create table t2(
  id bigint not null auto_increment primary key,
  person json not null,
  name char(20) as (json_value(person, '$.name' returning char)) virtual,
  age int as (json_value(person, '$.age' returning signed)) virtual,
  gis geometry not null srid 0,
  index idx_name(name),
  index idx_age(age),
  spatial index idx_gis(gis)
);
set @g = 'POINT(1 1)';
insert into t2(id, person, gis) values (1, '{"name": "tom", "age": 18}', ST_GeomFromText(@g));
select st_astext(gis) from t2 where st_intersects(gis, st_geomfromtext('POINT(1 1)'));
update t2 set gis=st_geomfromtext('POINT(1 0)');
select st_astext(gis) from t2 where st_intersects(gis, st_geomfromtext('POINT(1 1)'));
select st_astext(gis) from t2 where st_intersects(gis, st_geomfromtext('POINT(1 0)'));
drop table t2;

--disable_warnings
drop table if exists receivable_items;
--enable_warnings

CREATE TABLE `receivable_items` (
  `from_unit` int NOT NULL,
  `to_unit` int NOT NULL,
  `unit_range` linestring GENERATED ALWAYS AS (linestring(point(-(1),`from_unit`),point(1,`to_unit`))) STORED NOT NULL srid 0,
  `unit_point` point GENERATED ALWAYS AS (point(-(1),`from_unit`)) STORED NOT NULL srid 0,
  `unit_polygon` POLYGON GENERATED ALWAYS AS (POLYGON(LINESTRING(POINT(`from_unit`,0), POINT(`from_unit`,15), POINT(`to_unit`,0), POINT(`from_unit`,0)))) STORED NOT NULL srid 0,
  `unit_multipoint` multipoint GENERATED ALWAYS AS (multipoint(point(-(1),`from_unit`),point(1,`to_unit`))) STORED NOT NULL srid 0,
  `unit_multiline` multilinestring GENERATED ALWAYS AS (multilinestring(linestring(point(-(1),`from_unit`),point(1,`to_unit`)))) STORED NOT NULL srid 0,
  `unit_multipolygon` multipolygon GENERATED ALWAYS AS (multipolygon(POLYGON(LINESTRING(POINT(`from_unit`,0), POINT(`from_unit`,15), POINT(`to_unit`,0), POINT(`from_unit`,0))))) STORED NOT NULL srid 0,
  SPATIAL KEY `idx_unit_range` (`unit_range`),
  SPATIAL KEY `idx_unit_point` (`unit_point`),
  SPATIAL KEY `idx_unit_polygon` (`unit_polygon`),
  SPATIAL KEY `idx_unit_multipoint` (`unit_multipoint`),
  SPATIAL KEY `idx_unit_multiline` (`unit_multiline`),
  SPATIAL KEY `idx_unit_multipoly` (`unit_multipolygon`)
);

insert into receivable_items(from_unit, to_unit) values(120, 122), (10, 11), (21, 25), (33, 36), (-10, 10);
select st_astext(unit_point), st_astext(unit_range), st_astext(unit_polygon),st_astext(unit_multipoint),st_astext(unit_multiline),st_astext(unit_multipolygon) from receivable_items;
explain select from_unit, to_unit, st_astext(unit_point) from receivable_items where st_intersects(unit_point, point(-1, 120));
explain select from_unit, to_unit, st_astext(unit_polygon) from receivable_items where st_intersects(unit_polygon, point(-1, 120));
explain select from_unit, to_unit, st_astext(unit_multipoint) from receivable_items where st_intersects(unit_multipoint, point(-1, 120));
explain select from_unit, to_unit, st_astext(unit_multiline) from receivable_items where st_intersects(unit_multiline, point(-1, 120));
explain select from_unit, to_unit, st_astext(unit_multipolygon) from receivable_items where st_intersects(unit_multipolygon, point(-1, 120));
explain select from_unit, to_unit, st_astext(unit_range) from receivable_items where st_intersects(unit_range, point(-1, 120));
select from_unit, to_unit, st_astext(unit_range) from receivable_items where st_intersects(unit_range, point(-1, 120));
explain select from_unit, to_unit, st_astext(unit_range) from receivable_items where st_intersects(unit_range, st_geomfromtext('linestring(0 122, 0 -11)'));
select from_unit, to_unit, st_astext(unit_range) from receivable_items where st_intersects(unit_range, st_geomfromtext('linestring(0 122, 0 -11)'));
select from_unit, to_unit, st_astext(unit_range) from receivable_items ignore index(idx_unit_range) where st_intersects(unit_range, point(-1, 120));
select from_unit, to_unit, st_astext(unit_range) from receivable_items ignore index(idx_unit_range) where st_intersects(unit_range, st_geomfromtext('linestring(0 122, 0 -11)'));

drop table receivable_items;

CREATE TABLE `receivable_items` (
  `id` int(32) NOT NULL auto_increment,
  `geo_text` varchar(1024) NOT NULL,
  `unit_range` geometry GENERATED ALWAYS AS (st_geomfromtext(geo_text, 4326, 'axis-order=long-lat')) STORED NOT NULL srid 4326,
  SPATIAL KEY `idx_unit_range` (`unit_range`)
);

insert into receivable_items(geo_text) values('point(120.34904267189361 30.320965261625222)');
insert into receivable_items(geo_text) values('point(120.34904267189360 30.320965261625222)');
insert into receivable_items(geo_text) values('linestring(120.34904267189360 30.320965261625222, 120.34904267189361 30.320965261625222)');
insert into receivable_items(geo_text) values('linestring(120.34904267189361 30.320965261625222, 120.35612237862895 30.321118189268013)');
insert into receivable_items(geo_text) values('linestring(120.34904267189360 30.320965261625222, 120.34904267189360 30.320800629134425)');
insert into receivable_items(geo_text) values('MULTIPOLYGON (((120.34904267189361 30.320965261625222, 120.35612237862895 30.321118189268013, 120.35612237865006 30.32111818926693, 120.35460911503478 30.32080062911392, 120.3546091159729 30.320800629134425,  120.34904267189361 30.320965261625222)))');
insert into receivable_items(geo_text) values('MULTIPOLYGON (((110.34904267189361 30.320965261625222, 110.35812237862895 30.321118189268013, 110.35812237865006 30.32111818926693, 110.35460911503478 30.32080062911392, 110.3546091159729 30.320800629134425,  110.34904267189361 30.320965261625222)))');
insert into receivable_items(geo_text) values('GEOMETRYCOLLECTION(MULTIPOLYGON(((120.31599964855097 30.243634005580816,120.3160009095347 30.243635469782166,120.31600747846684 30.24364742764055,120.31601121779788 30.243660263421923,120.31601198353063 30.243673482839302,120.31599964855097 30.243634005580816)),((120.3160009095347 30.243635469782166,120.31600747846684 30.24364742764055,120.31601121779788 30.243660263421923,120.31601198353063 30.243673482839302,120.31601159806742 30.24367573874217,120.3160009095347 30.243635469782166))),POLYGON((120.31599964855097 30.243634005580816,120.3160009095347 30.243635469782166,120.31600747846684 30.24364742764055,120.31601121779788 30.243660263421923,120.31601198353063 30.243673482839302,120.31599964855097 30.243634005580816)),LINESTRING(120.31599964855097 30.243634005580816,120.3160009095347 30.243635469782166),MULTIPOINT(120.31599964855097 30.243634005580816,120.3160009095347 30.243635469782166,120.31600747846684 30.24364742764055),point(120.31599964855097 30.243634005580816))');
explain select id, st_astext(unit_range) from receivable_items where ST_Intersects(unit_range, ST_GeomFromText('MULTIPOLYGON (((120.34904267189361 30.320965261625222, 120.35612237862895 30.321118189268013, 120.35612237865006 30.32111818926693, 120.35460911503478 30.32080062911392, 120.3546091159729 30.320800629134425,  120.34904267189361 30.320965261625222)))',4326, 'axis-order=long-lat'));
select id, st_astext(unit_range) from receivable_items where ST_Intersects(unit_range, ST_GeomFromText('MULTIPOLYGON (((120.34904267189361 30.320965261625222, 120.35612237862895 30.321118189268013, 120.35612237865006 30.32111818926693, 120.35460911503478 30.32080062911392, 120.3546091159729 30.320800629134425,  120.34904267189361 30.320965261625222)))',4326, 'axis-order=long-lat'));
select id, st_astext(unit_range) from receivable_items where _ST_covers(ST_GeomFromText('MULTIPOLYGON (((120.34904267189361 30.320965261625222, 120.35612237862895 30.321118189268013, 120.35612237865006 30.32111818926693, 120.35460911503478 30.32080062911392, 120.3546091159729 30.320800629134425,  120.34904267189361 30.320965261625222)))',4326, 'axis-order=long-lat'), unit_range);
select id, st_astext(unit_range) from receivable_items ignore index(idx_unit_range) where ST_Intersects(unit_range, ST_GeomFromText('MULTIPOLYGON (((120.34904267189361 30.320965261625222, 120.35612237862895 30.321118189268013, 120.35612237865006 30.32111818926693, 120.35460911503478 30.32080062911392, 120.3546091159729 30.320800629134425,  120.34904267189361 30.320965261625222)))',4326, 'axis-order=long-lat'));
select id, st_astext(unit_range) from receivable_items ignore index(idx_unit_range) where _ST_covers(ST_GeomFromText('MULTIPOLYGON (((120.34904267189361 30.320965261625222, 120.35612237862895 30.321118189268013, 120.35612237865006 30.32111818926693, 120.35460911503478 30.32080062911392, 120.3546091159729 30.320800629134425,  120.34904267189361 30.320965261625222)))',4326, 'axis-order=long-lat'), unit_range);
select id, st_astext(unit_range) from receivable_items where ST_Intersects(unit_range, ST_GeomFromText('GEOMETRYCOLLECTION(MULTIPOLYGON (((120.34904267189361 30.320965261625222, 120.35612237862895 30.321118189268013, 120.35612237865006 30.32111818926693, 120.35460911503478 30.32080062911392, 120.3546091159729 30.320800629134425,  120.34904267189361 30.320965261625222))),POLYGON ((120.34904267189361 30.320965261625222, 120.35612237862895 30.321118189268013, 120.35612237865006 30.32111818926693, 120.35460911503478 30.32080062911392, 120.3546091159729 30.320800629134425,  120.34904267189361 30.320965261625222)),multipoint(120.34904267189361 30.320965261625222, 120.35612237862895 30.321118189268013, 120.35612237865006 30.32111818926693),point(120.31601198353063 30.243673482839302))',4326, 'axis-order=long-lat'));

drop table receivable_items;

CREATE TABLE `receivable_items` (
  `id` int(32) NOT NULL auto_increment,
  `geo_text` varchar(1024) NOT NULL,
  `unit_range` geometry GENERATED ALWAYS AS (st_geomfromtext(geo_text, 4326, 'axis-order=long-lat')) STORED NOT NULL srid 4326
);

insert into receivable_items(geo_text) values('point(120.34904267189361 30.320965261625222)');
insert into receivable_items(geo_text) values('point(120.34904267189360 30.320965261625222)');
insert into receivable_items(geo_text) values('linestring(120.34904267189360 30.320965261625222, 120.34904267189361 30.320965261625222)');
insert into receivable_items(geo_text) values('linestring(120.34904267189361 30.320965261625222, 120.35612237862895 30.321118189268013)');
insert into receivable_items(geo_text) values('linestring(120.34904267189360 30.320965261625222, 120.34904267189360 30.320800629134425)');
insert into receivable_items(geo_text) values('MULTIPOLYGON (((120.34904267189361 30.320965261625222, 120.35612237862895 30.321118189268013, 120.35612237865006 30.32111818926693, 120.35460911503478 30.32080062911392, 120.3546091159729 30.320800629134425,  120.34904267189361 30.320965261625222)))');
insert into receivable_items(geo_text) values('MULTIPOLYGON (((110.34904267189361 30.320965261625222, 110.35812237862895 30.321118189268013, 110.35812237865006 30.32111818926693, 110.35460911503478 30.32080062911392, 110.3546091159729 30.320800629134425,  110.34904267189361 30.320965261625222)))');
insert into receivable_items(geo_text) values('GEOMETRYCOLLECTION(MULTIPOLYGON(((120.31599964855097 30.243634005580816,120.3160009095347 30.243635469782166,120.31600747846684 30.24364742764055,120.31601121779788 30.243660263421923,120.31601198353063 30.243673482839302,120.31599964855097 30.243634005580816)),((120.3160009095347 30.243635469782166,120.31600747846684 30.24364742764055,120.31601121779788 30.243660263421923,120.31601198353063 30.243673482839302,120.31601159806742 30.24367573874217,120.3160009095347 30.243635469782166))),POLYGON((120.31599964855097 30.243634005580816,120.3160009095347 30.243635469782166,120.31600747846684 30.24364742764055,120.31601121779788 30.243660263421923,120.31601198353063 30.243673482839302,120.31599964855097 30.243634005580816)),LINESTRING(120.31599964855097 30.243634005580816,120.3160009095347 30.243635469782166),MULTIPOINT(120.31599964855097 30.243634005580816,120.3160009095347 30.243635469782166,120.31600747846684 30.24364742764055),point(120.31599964855097 30.243634005580816))');

select id, st_astext(unit_range) from receivable_items where ST_Intersects(unit_range, ST_GeomFromText('MULTIPOLYGON (((120.34904267189361 30.320965261625222, 120.35612237862895 30.321118189268013, 120.35612237865006 30.32111818926693, 120.35460911503478 30.32080062911392, 120.3546091159729 30.320800629134425,  120.34904267189361 30.320965261625222)))',4326, 'axis-order=long-lat'));
select id, st_astext(unit_range) from receivable_items where _ST_covers(ST_GeomFromText('MULTIPOLYGON (((120.34904267189361 30.320965261625222, 120.35612237862895 30.321118189268013, 120.35612237865006 30.32111818926693, 120.35460911503478 30.32080062911392, 120.3546091159729 30.320800629134425,  120.34904267189361 30.320965261625222)))',4326, 'axis-order=long-lat'), unit_range);
select id, st_astext(unit_range) from receivable_items where ST_Intersects(unit_range, ST_GeomFromText('GEOMETRYCOLLECTION(MULTIPOLYGON (((120.34904267189361 30.320965261625222, 120.35612237862895 30.321118189268013, 120.35612237865006 30.32111818926693, 120.35460911503478 30.32080062911392, 120.3546091159729 30.320800629134425,  120.34904267189361 30.320965261625222))),POLYGON ((120.34904267189361 30.320965261625222, 120.35612237862895 30.321118189268013, 120.35612237865006 30.32111818926693, 120.35460911503478 30.32080062911392, 120.3546091159729 30.320800629134425,  120.34904267189361 30.320965261625222)),multipoint(120.34904267189361 30.320965261625222, 120.35612237862895 30.321118189268013, 120.35612237865006 30.32111818926693),point(120.31601198353063 30.243673482839302))',4326, 'axis-order=long-lat'));
# index rebuild
create SPATIAL index if not exists `idx_unit_range` on `receivable_items` (`unit_range`);
explain select id, st_astext(unit_range) from receivable_items where ST_Intersects(unit_range, ST_GeomFromText('MULTIPOLYGON (((120.34904267189361 30.320965261625222, 120.35612237862895 30.321118189268013, 120.35612237865006 30.32111818926693, 120.35460911503478 30.32080062911392, 120.3546091159729 30.320800629134425,  120.34904267189361 30.320965261625222)))',4326, 'axis-order=long-lat'));
select id, st_astext(unit_range) from receivable_items where ST_Intersects(unit_range, ST_GeomFromText('MULTIPOLYGON (((120.34904267189361 30.320965261625222, 120.35612237862895 30.321118189268013, 120.35612237865006 30.32111818926693, 120.35460911503478 30.32080062911392, 120.3546091159729 30.320800629134425,  120.34904267189361 30.320965261625222)))',4326, 'axis-order=long-lat'));
select id, st_astext(unit_range) from receivable_items where _ST_covers(ST_GeomFromText('MULTIPOLYGON (((120.34904267189361 30.320965261625222, 120.35612237862895 30.321118189268013, 120.35612237865006 30.32111818926693, 120.35460911503478 30.32080062911392, 120.3546091159729 30.320800629134425,  120.34904267189361 30.320965261625222)))',4326, 'axis-order=long-lat'), unit_range);
select id, st_astext(unit_range) from receivable_items where ST_Intersects(unit_range, ST_GeomFromText('GEOMETRYCOLLECTION(MULTIPOLYGON (((120.34904267189361 30.320965261625222, 120.35612237862895 30.321118189268013, 120.35612237865006 30.32111818926693, 120.35460911503478 30.32080062911392, 120.3546091159729 30.320800629134425,  120.34904267189361 30.320965261625222))),POLYGON ((120.34904267189361 30.320965261625222, 120.35612237862895 30.321118189268013, 120.35612237865006 30.32111818926693, 120.35460911503478 30.32080062911392, 120.3546091159729 30.320800629134425,  120.34904267189361 30.320965261625222)),multipoint(120.34904267189361 30.320965261625222, 120.35612237862895 30.321118189268013, 120.35612237865006 30.32111818926693),point(120.31601198353063 30.243673482839302))',4326, 'axis-order=long-lat'));
drop table receivable_items;

# build spatial index on virtual GENERATED column isn't supported, same as mysql
--error 3106
CREATE TABLE `receivable_items` (
  `id` int(32) NOT NULL auto_increment,
  `geo_text` varchar(1024) NOT NULL,
  `unit_range` geometry GENERATED ALWAYS AS (st_geomfromtext(geo_text, 4326, 'axis-order=long-lat')) NOT NULL srid 4326,
  SPATIAL KEY `idx_unit_range` (`unit_range`)
);

# partition table
CREATE TABLE `receivable_items` (
  `id` int(32) NOT NULL auto_increment primary key,
  `geo_text` varchar(1024) NOT NULL,
  `unit_range` geometry GENERATED ALWAYS AS (st_geomfromtext(geo_text, 4326, 'axis-order=long-lat')) STORED NOT NULL srid 4326,
  SPATIAL KEY `idx_unit_range` (`unit_range`)
) partition by hash(id) partitions 3;

insert into receivable_items(geo_text) values('point(120.34904267189361 30.320965261625222)');
insert into receivable_items(geo_text) values('point(120.34904267189360 30.320965261625222)');
insert into receivable_items(geo_text) values('linestring(120.34904267189360 30.320965261625222, 120.34904267189361 30.320965261625222)');
insert into receivable_items(geo_text) values('linestring(120.34904267189361 30.320965261625222, 120.35612237862895 30.321118189268013)');
insert into receivable_items(geo_text) values('linestring(120.34904267189360 30.320965261625222, 120.34904267189360 30.320800629134425)');
insert into receivable_items(geo_text) values('MULTIPOLYGON (((120.34904267189361 30.320965261625222, 120.35612237862895 30.321118189268013, 120.35612237865006 30.32111818926693, 120.35460911503478 30.32080062911392, 120.3546091159729 30.320800629134425,  120.34904267189361 30.320965261625222)))');
insert into receivable_items(geo_text) values('MULTIPOLYGON (((110.34904267189361 30.320965261625222, 110.35812237862895 30.321118189268013, 110.35812237865006 30.32111818926693, 110.35460911503478 30.32080062911392, 110.3546091159729 30.320800629134425,  110.34904267189361 30.320965261625222)))');
insert into receivable_items(geo_text) values('GEOMETRYCOLLECTION(MULTIPOLYGON(((120.31599964855097 30.243634005580816,120.3160009095347 30.243635469782166,120.31600747846684 30.24364742764055,120.31601121779788 30.243660263421923,120.31601198353063 30.243673482839302,120.31599964855097 30.243634005580816)),((120.3160009095347 30.243635469782166,120.31600747846684 30.24364742764055,120.31601121779788 30.243660263421923,120.31601198353063 30.243673482839302,120.31601159806742 30.24367573874217,120.3160009095347 30.243635469782166))),POLYGON((120.31599964855097 30.243634005580816,120.3160009095347 30.243635469782166,120.31600747846684 30.24364742764055,120.31601121779788 30.243660263421923,120.31601198353063 30.243673482839302,120.31599964855097 30.243634005580816)),LINESTRING(120.31599964855097 30.243634005580816,120.3160009095347 30.243635469782166),MULTIPOINT(120.31599964855097 30.243634005580816,120.3160009095347 30.243635469782166,120.31600747846684 30.24364742764055),point(120.31599964855097 30.243634005580816))');
explain select id, st_astext(unit_range) from receivable_items where ST_Intersects(unit_range, ST_GeomFromText('MULTIPOLYGON (((120.34904267189361 30.320965261625222, 120.35612237862895 30.321118189268013, 120.35612237865006 30.32111818926693, 120.35460911503478 30.32080062911392, 120.3546091159729 30.320800629134425,  120.34904267189361 30.320965261625222)))',4326, 'axis-order=long-lat'));
select id, st_astext(unit_range) from receivable_items where ST_Intersects(unit_range, ST_GeomFromText('MULTIPOLYGON (((120.34904267189361 30.320965261625222, 120.35612237862895 30.321118189268013, 120.35612237865006 30.32111818926693, 120.35460911503478 30.32080062911392, 120.3546091159729 30.320800629134425,  120.34904267189361 30.320965261625222)))',4326, 'axis-order=long-lat'));
select id, st_astext(unit_range) from receivable_items where _ST_covers(ST_GeomFromText('MULTIPOLYGON (((120.34904267189361 30.320965261625222, 120.35612237862895 30.321118189268013, 120.35612237865006 30.32111818926693, 120.35460911503478 30.32080062911392, 120.3546091159729 30.320800629134425,  120.34904267189361 30.320965261625222)))',4326, 'axis-order=long-lat'), unit_range);
select id, st_astext(unit_range) from receivable_items ignore index(idx_unit_range) where ST_Intersects(unit_range, ST_GeomFromText('MULTIPOLYGON (((120.34904267189361 30.320965261625222, 120.35612237862895 30.321118189268013, 120.35612237865006 30.32111818926693, 120.35460911503478 30.32080062911392, 120.3546091159729 30.320800629134425,  120.34904267189361 30.320965261625222)))',4326, 'axis-order=long-lat'));
select id, st_astext(unit_range) from receivable_items ignore index(idx_unit_range) where _ST_covers(ST_GeomFromText('MULTIPOLYGON (((120.34904267189361 30.320965261625222, 120.35612237862895 30.321118189268013, 120.35612237865006 30.32111818926693, 120.35460911503478 30.32080062911392, 120.3546091159729 30.320800629134425,  120.34904267189361 30.320965261625222)))',4326, 'axis-order=long-lat'), unit_range);
select id, st_astext(unit_range) from receivable_items where ST_Intersects(unit_range, ST_GeomFromText('GEOMETRYCOLLECTION(MULTIPOLYGON (((120.34904267189361 30.320965261625222, 120.35612237862895 30.321118189268013, 120.35612237865006 30.32111818926693, 120.35460911503478 30.32080062911392, 120.3546091159729 30.320800629134425,  120.34904267189361 30.320965261625222))),POLYGON ((120.34904267189361 30.320965261625222, 120.35612237862895 30.321118189268013, 120.35612237865006 30.32111818926693, 120.35460911503478 30.32080062911392, 120.3546091159729 30.320800629134425,  120.34904267189361 30.320965261625222)),multipoint(120.34904267189361 30.320965261625222, 120.35612237862895 30.321118189268013, 120.35612237865006 30.32111818926693),point(120.31601198353063 30.243673482839302))',4326, 'axis-order=long-lat'));

drop index idx_unit_range on receivable_items;

# spatial index rebuild, partition table
create SPATIAL index if not exists `idx_unit_range` on `receivable_items` (`unit_range`);
explain select id, st_astext(unit_range) from receivable_items where ST_Intersects(unit_range, ST_GeomFromText('MULTIPOLYGON (((120.34904267189361 30.320965261625222, 120.35612237862895 30.321118189268013, 120.35612237865006 30.32111818926693, 120.35460911503478 30.32080062911392, 120.3546091159729 30.320800629134425,  120.34904267189361 30.320965261625222)))',4326, 'axis-order=long-lat'));
select id, st_astext(unit_range) from receivable_items where ST_Intersects(unit_range, ST_GeomFromText('MULTIPOLYGON (((120.34904267189361 30.320965261625222, 120.35612237862895 30.321118189268013, 120.35612237865006 30.32111818926693, 120.35460911503478 30.32080062911392, 120.3546091159729 30.320800629134425,  120.34904267189361 30.320965261625222)))',4326, 'axis-order=long-lat'));
select id, st_astext(unit_range) from receivable_items where _ST_covers(ST_GeomFromText('MULTIPOLYGON (((120.34904267189361 30.320965261625222, 120.35612237862895 30.321118189268013, 120.35612237865006 30.32111818926693, 120.35460911503478 30.32080062911392, 120.3546091159729 30.320800629134425,  120.34904267189361 30.320965261625222)))',4326, 'axis-order=long-lat'), unit_range);
select id, st_astext(unit_range) from receivable_items where ST_Intersects(unit_range, ST_GeomFromText('GEOMETRYCOLLECTION(MULTIPOLYGON (((120.34904267189361 30.320965261625222, 120.35612237862895 30.321118189268013, 120.35612237865006 30.32111818926693, 120.35460911503478 30.32080062911392, 120.3546091159729 30.320800629134425,  120.34904267189361 30.320965261625222))),POLYGON ((120.34904267189361 30.320965261625222, 120.35612237862895 30.321118189268013, 120.35612237865006 30.32111818926693, 120.35460911503478 30.32080062911392, 120.3546091159729 30.320800629134425,  120.34904267189361 30.320965261625222)),multipoint(120.34904267189361 30.320965261625222, 120.35612237862895 30.321118189268013, 120.35612237865006 30.32111818926693),point(120.31601198353063 30.243673482839302))',4326, 'axis-order=long-lat'));

--error 1138
alter table receivable_items modify `unit_range` geometry GENERATED ALWAYS AS (st_geomfromtext(geo_text, 4326, 'axis-order=long-lat')) NOT NULL srid 4326;
--error 3106
alter table receivable_items modify `unit_range` geometry GENERATED ALWAYS AS (st_geomfromtext(geo_text, 4326, 'axis-order=long-lat')) srid 4326;
--error 1235
alter table receivable_items modify `unit_range` geometry GENERATED ALWAYS AS (st_geomfromtext(geo_text, 4326)) STORED srid 4326;
--error 1235
alter table receivable_items modify `unit_range` geometry GENERATED ALWAYS AS (st_geomfromtext(geo_text, 4326, 'axis-order=long-lat')) srid 0;
drop table receivable_items;

--disable_warnings
drop table if exists t1;
drop procedure if exists pl1;
--enable_warnings
CREATE TABLE t1 (
   id int auto_increment NOT NULL,
   c1 varchar(200),
   c2 json,
   c3 blob,
   c4 geometry not null srid 4326,
   from_unit double NOT NULL,
   to_unit double NOT NULL,
   g geometry GENERATED ALWAYS AS (_st_setsrid(LINESTRING(point(from_unit,30.320965261625222),point(120.34904267189361,to_unit)),4326)) STORED NOT NULL srid 4326,
  SPATIAL KEY `idx_g` (g)
)partition by hash(id) partitions 3;

delimiter //;
create procedure pl1(ll int)
    begin
        set @x=120.34904267189300;
        set @y=30.320965261625200;
        set @z=1;
        repeat
            insert into t1(c1,c2,c3,c4,from_unit,to_unit) values ('point(120.34904267189361 30.320965261625222)','{"key": "point(120.34904267189361 30.320965261625222)"}','point(120.34904267189361 30.320965261625222)',ST_GeomFromText('point(120.34904267189361 30.320965261625222)',4326, 'axis-order=long-lat'),@x,@y);
            set @x=@x + 1e-14;
            set @y=@y + 1e-14;
            set @z=@z+1;
        until @z>ll end repeat;
    end
//
delimiter ;//
call pl1(100);
alter table t1 add g2 geometry GENERATED ALWAYS AS (_st_setsrid(LINESTRING(point(from_unit,30.320965261625222),point(120.34904267189361,to_unit)),4326)) STORED  srid 4326;
