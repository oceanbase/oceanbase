#owner: shouju.zyp
#owner group: RS
#tags: views
#description:
# DBA_OB_TENANTS

connect (sys,$OBMYSQL_MS0,root,,oceanbase,$OBMYSQL_PORT);
connection sys;
--disable_warnings
drop tenant if exists tenant1 force;
drop resource pool if exists pool_tenant1;
drop resource unit if exists test_unit;
--enable_warnings
CREATE RESOURCE UNIT test_unit MAX_CPU=1, MEMORY_SIZE='2G';
CREATE RESOURCE POOL pool_tenant1 UNIT test_unit, UNIT_NUM 1;
CREATE TENANT tenant1 RESOURCE_POOL_LIST=('pool_tenant1'), PRIMARY_ZONE='zone1', COMMENT='this is tenant1' SET ob_tcp_invited_nodes='%', ob_compatibility_mode='mysql';

DESC DBA_OB_TENANTS;
# case 1: test sys can access
select TENANT_NAME, TENANT_TYPE, COMPATIBILITY_MODE, STATUS, IN_RECYCLEBIN, LOCKED, TENANT_ROLE, SWITCHOVER_STATUS, LOG_MODE, UNIT_NUM, RESTORE_DATA_MODE, COMMENT from DBA_OB_TENANTS where TENANT_NAME = 'tenant1';
ALTER TENANT tenant1 set comment="I am tenant1";

SELECT count(distinct(tenant_id)) >= 1  FROM DBA_OB_TENANTS;

select TENANT_NAME, TENANT_TYPE, COMPATIBILITY_MODE, STATUS, IN_RECYCLEBIN, LOCKED, TENANT_ROLE, SWITCHOVER_STATUS, LOG_MODE, UNIT_NUM, RESTORE_DATA_MODE, COMMENT from DBA_OB_TENANTS where TENANT_NAME = 'tenant1';
select TENANT_NAME, TENANT_TYPE, COMPATIBILITY_MODE, STATUS, IN_RECYCLEBIN, LOCKED, TENANT_ROLE, SWITCHOVER_STATUS, LOG_MODE, UNIT_NUM, RESTORE_DATA_MODE, COMMENT from DBA_OB_TENANTS where TENANT_TYPE = 'SYS';
eval select TENANT_TYPE, COMPATIBILITY_MODE, STATUS, IN_RECYCLEBIN, LOCKED, TENANT_ROLE, SWITCHOVER_STATUS, LOG_MODE, SYNC_SCN, REPLAYABLE_SCN, READABLE_SCN, RECOVERY_UNTIL_SCN, UNIT_NUM, RESTORE_DATA_MODE from DBA_OB_TENANTS where TENANT_TYPE = 'META' limit 1;
select count(*) from DBA_OB_TENANTS where COMPATIBLE != (SELECT MIN(VALUE) FROM GV$OB_PARAMETERS WHERE NAME = 'compatible');
# 0
select count(*) from DBA_OB_TENANTS where SYNC_SCN >= REPLAYABLE_SCN and REPLAYABLE_SCN>=READABLE_SCN and RECOVERY_UNTIL_SCN !=0 and TENANT_TYPE = "USER" and TENANT_NAME = 'tenant1';
# 1

select count(*) from DBA_OB_TENANTS where SYNC_SCN is NULL and REPLAYABLE_SCN is NULL and READABLE_SCN is NULL and RECOVERY_UNTIL_SCN  is NULL and TENANT_TYPE = 'SYS';
# 1

# case 2: other database can access
USE TEST;

SELECT count(distinct(tenant_id)) >= 1  FROM oceanbase.DBA_OB_TENANTS;

# case 3: mysql tenant can access
connect(conn_tenant1, $OBMYSQL_MS0, root@tenant1, , oceanbase, $OBMYSQL_PORT);
connection conn_tenant1;
DESC DBA_OB_TENANTS;

SELECT TENANT_NAME, count(*) = 1  FROM oceanbase.DBA_OB_TENANTS group by TENANT_ID;
select TENANT_NAME, TENANT_TYPE, COMPATIBILITY_MODE, STATUS, IN_RECYCLEBIN, LOCKED, TENANT_ROLE, SWITCHOVER_STATUS, LOG_MODE, UNIT_NUM, COMMENT from oceanbase.DBA_OB_TENANTS;
select count(*) from oceanbase.DBA_OB_TENANTS where COMPATIBLE != (SELECT MIN(VALUE) FROM oceanbase.GV$OB_PARAMETERS WHERE NAME = 'compatible');
# 0
select count(*) from oceanbase.DBA_OB_TENANTS where SYNC_SCN >= REPLAYABLE_SCN and REPLAYABLE_SCN>=READABLE_SCN and RECOVERY_UNTIL_SCN !=0 and TENANT_TYPE = "USER";
# 1

# case 4: test tenant role after switchover on sys connection
connection sys;
ALTER SYSTEM SWITCHOVER TO STANDBY TENANT tenant1;
select TENANT_NAME, TENANT_TYPE, COMPATIBILITY_MODE, STATUS, IN_RECYCLEBIN, LOCKED, TENANT_ROLE, SWITCHOVER_STATUS, LOG_MODE, UNIT_NUM, COMMENT from oceanbase.DBA_OB_TENANTS where TENANT_NAME = 'tenant1';
select count(*) from oceanbase.DBA_OB_TENANTS where SYNC_SCN >= REPLAYABLE_SCN and REPLAYABLE_SCN>=READABLE_SCN and RECOVERY_UNTIL_SCN !=0 and TENANT_TYPE = "USER" and TENANT_NAME = 'tenant1';
# 1

# case 5: test tenant role after switchover on mysql connection
connection conn_tenant1;
select TENANT_NAME, TENANT_TYPE, COMPATIBILITY_MODE, STATUS, IN_RECYCLEBIN, LOCKED, TENANT_ROLE, SWITCHOVER_STATUS, LOG_MODE, UNIT_NUM, COMMENT from oceanbase.DBA_OB_TENANTS where TENANT_NAME = 'tenant1';
select count(*) from oceanbase.DBA_OB_TENANTS where SYNC_SCN >= REPLAYABLE_SCN and REPLAYABLE_SCN>=READABLE_SCN and RECOVERY_UNTIL_SCN !=0 and TENANT_TYPE = "USER" and TENANT_NAME = 'tenant1';
# 1

connection sys;
ALTER SYSTEM SWITCHOVER TO PRIMARY TENANT tenant1;
let $check_can_write_tenant_id = query_get_value(select TENANT_ID from oceanbase.DBA_OB_TENANTS where TENANT_NAME = 'mysql', TENANT_ID, 1);
--disable_query_log
--source mysql_test/include/check_tenant_can_write.inc
--enable_query_log

# case 6: 验证DBA_OB_TENANTS视图是否可以根据访问的列而做裁剪
# 6.1 只访问__all_tenant表相关列，期望查询视图的过程中内部只访问__all_tenant表
use oceanbase;
EXPLAIN BASIC select tenant_name,status from DBA_OB_TENANTS where tenant_name = 'tenant1';

# 6.2 访问了__all_virtual_tenant_info的列，期望查询到__all_tenant_info表
EXPLAIN BASIC select tenant_role,switchover_status from DBA_OB_TENANTS where tenant_name = 'tenant1';

drop tenant if exists tenant1 force;
drop resource pool if exists pool_tenant1;
drop resource unit if exists test_unit;